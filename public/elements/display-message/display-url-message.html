<link rel="import" href="/platform/bower_components/polymer/polymer.html">
<link rel="import" href="/platform/bower_components/core-ajax/core-ajax.html">
<link rel="import" href="/platform/bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="display-default-message.html">
<link rel="import" href="event-image.html">
<link rel="import" href="event-video.html">
<polymer-element name="display-url-message" extends="display-default-message" attributes="url previewHidden">

<template>
	<style>
		.attachment_service_name {
			color: #9e9ea6;
		}
		.attachment_title {
			font-weight: bold;
			font-size: 16px;
		}
		.previewHidden {
			display: none;
		}

		
	</style>
	<core-localstorage id="ls" name="im.ogpMap" value="{{ogpMap}}"></core-localstorage>
<core-ajax id='getOGP'
    auto='false'
    method="GET"
    url="{{serverUrl}}/api/urlMetadata"
    params="{{queryURL}}" 
    handleAs="json"
    response="{{ogp}}"
    ></core-ajax>

    <a href="{{url}}" target="{{url}}"><shadow></shadow></a>
	
	<div class='{{previewHidden}}' vertical layout>
		<div>
			<template if="{{urlSiteName}}">
				<span class="attachment_service_name {{previewHidden}}">{{urlSiteName}}</span>
			</template>
		</div>
		<div>
			<template if="{{urlTitle}}">
				<span class="attachment_title {{previewHidden}}"><a href="{{url}}" rel="noreferrer" target="{{url}}">{{urlTitle}}</a></span>
			</template>
		</div>
		<div>
			<template if="{{urlDescription}}">
				<div class="attachment_contents {{previewHidden}}">{{urlDescription}}</div>
			</template>
		</div>
		<div>
			<template if="{{!videoURL && urlImage}}">
				<event-image class='{{previewHidden}}' src="{{urlImage}}" width="400px" on-imageloaded="{{imageLoaded}}"></event-image>
			</template>
			<template if="{{videoURL}}">
				<event-video class='{{previewHidden}}' src="{{videoURL}}" width="{{videoWidth}}" height="{{videoHeight}}" on-videoloaded="{{imageLoaded}}"></event-video>
			</template>
		</div>
	</div>
</template>
<script src="../../bower_components/lodash/dist/lodash.min.js"></script>
<script>
	var hostname = window.location.hostname +':'+ window.location.port;
	var serverUrl = 'http://' + hostname + '/im';
	Polymer({
		urlTitle: '',
		urlDescription: '', 
		urlImage: '',
		urlSiteName: '',
		videoWidth: 0,
		videoHeight: 0,
		disableLoadedEvent: false,
		/**
		 * key : queryUrl
		 * value : org meta
		 */
		ogpMap: {},
		domReady: function(){
			this.serverUrl = serverUrl;
			this.queryURL = JSON.stringify({"url":this.url});
			this.deleteOldMeta();
			if (this.ogpMap[this.queryURL]) {
				this.ogp = this.ogpMap[this.queryURL].meta;
			} else {
				this.$.getOGP.go();
			}
		}, 
		ogpChanged: function(oldValue, newValue){
			if (newValue.og.description){
				this.urlDescription = newValue.og.description;
			}else if(newValue.description){
				this.urlDescription = newValue.description;
			}
			if (newValue.og.title){
				this.urlTitle = newValue.og.title;
			}
			if (newValue.og.image && newValue.og.image.url){
				this.urlImage = newValue.og.image.url;
			}
			if (newValue.og.site_name){
				this.urlSiteName = newValue.og.site_name;
			}
			if (newValue.og.video && newValue.og.video.url){
				this.videoURL = newValue.og.video.url;
			}
			if (newValue.og.video && newValue.og.video.height){
				try{
					this.videoHeight = parseInt(newValue.og.video.height);
				}catch(err){}
			}
			if (newValue.og.video && newValue.og.video.width){
				try{
					this.videoWidth = parseInt(newValue.og.video.width);
				}catch(err){}
			}
			if (!this.urlImage && !this.videoURL ){
				this.fire('loaded', '');
			}
			this.ogpMap[this.queryURL] = {
				updatedAt : new Date(),
				meta : newValue
			};
			this.$.ls.save();
		},
		deleteOldMeta : function(){
			var oldKeys = [];
			var now = new Date();
			var oneWeek = 86400 * 1000 * 7;
			var self = this;
			Object.keys(this.ogpMap).forEach(function(url) {
				if (now - new Date(self.ogpMap[url].updatedAt) > oneWeek) {
					oldKeys.push(url);
				}
			});

			oldKeys.forEach(function(key) {
				delete this.ogpMap[key];
			}, this);
			this.$.ls.save();
		},
		imageLoaded: function(event){
			this.fire('loaded', '');
		}
	});
</script>
</polymer-element>