<link rel="import" href="/platform/bower_components/polymer/polymer.html">
<link rel="import" href="/platform/bower_components/core-ajax/core-ajax.html">
<link rel="import" href="/platform/bower_components/core-style/core-style.html">
<link rel="import" href="/platform/bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="/platform/bower_components/core-menu/core-menu.html">
<link rel="import" href="/platform/bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/platform/bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="/platform/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/platform/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/platform/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/platform/bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="/platform/bower_components/paper-item/paper-item.html">
<link rel="import" href="/platform/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/platform/bower_components/core-icon/core-icon.html">
<link rel="import" href="/platform/bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/platform/bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="/platform/bower_components/paper-input/paper-input.html">
<link rel="import" href="/platform/bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="/platform/bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="/platform/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/platform/bower_components/core-header-panel/core-header-panel.html">

<link rel="import" href="/platform/home-container.html">
<link rel="import" href="/platform/elements/member-select/member-element.html">
<link rel="import" href="/platform/elements/member-select/member-select.html">
<link rel="import" href="/platform/elements/app-globals/app-globals.html">

<link rel="import" href="../display-message/display-message.html">
<link rel="import" href="../event-infinite-scroll/event-infinite-scroll.html">
<link rel="import" href="../imchannels/im-channnels.html">
<link rel="import" href="../imhistory/im-history.html">

<polymer-element name="instant-message" attributes="channelName">
    <template>
        <app-globals id="globals"></app-globals>
        <link rel="stylesheet" type="text/css" href="instant-message.css">
        <core-style ref="theme"></core-style>
        <paper-action-dialog id="addPrivateChannelDialog" heading="Add Private Channel" backdrop autoCloseDisabled
                             closeSelector="#cancelBtn" style="width: 70%; height: 70%;">
            <paper-input-decorator id="privateChannelNameInput" label="Channel Name" floatingLabel autoValidate
                                   style="width: 100%;" error="{{newPrivateChannel.error.msg}}">
                <input is="core-input" required value="{{newPrivateChannel.name}}">
            </paper-input-decorator>
            <member-select type="user" selected="{{newPrivateChannel}}" width="100%;"></member-select>
            <paper-button id="cancelBtn" dismissive>Cancel</paper-button>
            <paper-button affirmative on-click="{{addPrivateChannel}}" disabled="{{newPrivateChannelUsersInvalid}}">OK
            </paper-button>
        </paper-action-dialog>


        <paper-action-dialog id="removePrivateChannelDialog" heading="Leaving {{ removedPrivateChannel.name }}" backdrop
                             autoCloseDisabled closeSelector="#cancelBtn" style="width: 30%; height: 30%;">
            <p>Are you sure</p>
            <paper-button id="cancelBtn" dismissive>Close</paper-button>
            <paper-button affirmative channelId="{{removedPrivateChannel.id}}" on-click="{{removePrivateChannel}}">Yes
            </paper-button>
        </paper-action-dialog>

        <home-container>
            <div class="title" horizontal layout center>
                <div flex>
                    {{ channelName }}
                </div>
                <div horizontal end-justified layout>
                    <core-icon-button id="menuButton" class='{{ {narrowShow :!narrow} | tokenList }}' icon="menu"
                                      on-tap="{{togglePanel}}"></core-icon-button>
                </div>
            </div>

            <div class="mainBackground" horizontal layout fit>
                <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" rightDrawer>
                    <paper-action-dialog id="connectingDialog" backdrop autoCloseDisabled>
                        <p>{{connectinStatus}}</p>
                    </paper-action-dialog>

                    <div id="forbiddenDiv" hidden main four flex horizontal layout center center-justified>
                        <div style="font-size: 3em; font-weight: bold;">
                            You are not allowed to access this channel
                        </div>
                    </div>
                    <div id="historyAndInput" main four flex vertical layout class="mainBgColor">

                        <div id="history" flex>
                            <event-infinite-scroll id="infiniteScroll" readyOnStart="false" scrollDenominator="2"
                                                   loadingDelay="50"
                                                   on-reach-top="{{reachedTop}}"></event-infinite-scroll>
                            <template repeat="{{m in messages}}">
                                <display-message user="{{m.userId}}" text="{{m.text}}"
                                                 on-messageloaded="{{messageLoaded}}"
                                                 messageStatus="{{m.messageStatus}}"
                                                 updatedAt="{{m.updatedAt}}"
                                                 disableEvent="{{m.disableEvent}}"
                                                 hideMemberElement="{{m.hideMemberElement}}"
                                                 messageGuid="{{m.guid}}"
                                                 previewHidden="{{m.displayPreview}}"
                                                 on-ready="{{messageReady}}"></display-message>
                            </template>
                        </div>

                        <div id="imHistory" is="im-history" flex channel="{{channel}}" unread="{{unread}}"></div>

                        <div>
                            <paper-toast id="comingMessageToast" text="New Message">
                                from
                                <member-element userid="{{comingMessage.userId}}"></member-element>
                            </paper-toast>
                        </div>
                        <div layout horizontal center>
                            <div id="inputbox" on-tap="{{boxTapped}}" flex>
                                <div layout horizontal>
                                    <paper-autogrow-textarea id="messageInput" maxRows="6" on-keydown="{{keyDown}}"
                                                             on-input="{{inputChanging}}" flex>
                                        <textarea row="1" id="textInput" value="{{message}}"></textarea>
                                    </paper-autogrow-textarea>
                                </div>
                            </div>
                            <div layout horizontal center>
                                <span id='informationButton' class="input-group-addon "
                                      on-tap="{{onClickInfomation}}">!</span>
                            </div>
                        </div>
                    </div>

                    <div id='imPanel' drawer vertical layout flex>
                        <div id="groupImChannels" is="im-channels" channels="{{publicChannels}}" unread="{{unread}}"
                             currentChannel="{{channel}}" showMemberList >
                            <div class="title">
                                <h3 class="secondColor">Group Channel</h3>
                            </div>
                        </div>

                        <div id="privateImChannels" is="im-channels" channels="{{privateChannels}}" unread="{{unread}}"
                             currentChannel="{{channel}}" removable>
                            <div class="title secondColor" flex horizontal layout center>
                                <div flex>
                                    <h3>Private Channels</h3>
                                </div>
                                <div>
                                    <paper-icon-button icon="add-circle-outline"
                                                       on-click="{{ showAddPrivateChannelDialog}}">
                                    </paper-icon-button>
                                </div>
                            </div>
                        </div>

                        <div id="teamMemberImChannels" is="im-channels" channels="{{teamMemberChannels}}" unread="{{unread}}"
                             currentChannel="{{channel}}" flex vertical layout>
                            <div class="title" flex>
                                <h3 class="secondColor">Direct Message</h3>
                            </div>
                        </div>
                    </div>

                </core-drawer-panel>
            </div>

            <paper-dialog id="informationDialog" transition="core-transition-center" heading="Manual">
                <p>1. ENTER to send</p>

                <p>2. SHIFT + ENTER to have newline</p>

                <p>3. Code Snippet

                <div layout horizontal center>
                    <div>
                        Input:
                        <pre>{{codeSnippetExample}}</pre>
                    </div>
                    <div>
                        Display:
                        <display-code-snippet-message text="{{codeSnippetExample}}"></display-code-snippet-message>
                    </div>
                </div>
                </p>
            </paper-dialog>


        </home-container>
    </template>

    <script src="../../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../../bower_components/async/lib/async.js"></script>
    <script src="../../bower_components/lodash/dist/lodash.min.js"></script>
    <script src="instant-message.web.js"></script>
</polymer-element>